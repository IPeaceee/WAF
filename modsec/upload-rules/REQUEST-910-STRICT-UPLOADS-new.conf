### REQUEST-910-STRICT-UPLOADS.conf ###
# ID range used: 999100-999199 (custom rules)
# Phase: 2 (request body)
# Tags: waf:upload
# Severity: 2 (medium)

# --- Deny filenames with disallowed extensions (positive allowlist) ---
# Allowed extensions: xlsx, xls, jpg, jpeg, png, pdf
SecRule MULTIPART_FILENAME "!@rx (?i)(?:^|[\\\/])[^\\\/]+\.(?:xlsx|xls|jpe?g|png|pdf)$" \
    "id:999110,phase:2,deny,status:403,log,t:none,tag:'waf:upload',severity:2,msg:'Upload denied: Extension is not allowed (got: %{MATCHED_VAR})'"

#####------------------------------------------------------------------------------------#####
# --- Mapping: Extension must match per-part Content-Type (if part headers available) ---
#####------------------------------------------------------------------------------------#####
# JPEG
SecRule MULTIPART_FILENAME "@rx (?i)\.jpe?g$" \
  "id:999111,phase:2,pass,log,chain,t:none,tag:'waf:upload',severity:2,msg:'JPEG: check MIME follow Content-Type'"
SecRule &MULTIPART_PART_HEADERS:Content-Type "@ge 1" "pass,chain,t:none"
SecRule MULTIPART_PART_HEADERS:Content-Type "!@rx (?i)^image/(?:jpeg|pjpeg|jpg)(?:\s*;.*)?$" \
  "deny,status:403,log,msg:'Upload denied: The JPEG has an invalid Content-Type (got: %{MATCHED_VAR})'"

#####------------------------------------------------------------------------------------#####
# Khởi tạo danh sách MIME hợp lệ cho XLS / XLSX
SecAction "id:999100,phase:1,nolog,pass, \
  setvar:'tx.allowed_mime_xls=application/vnd.ms-excel|application/msexcel|application/x-msexcel|application/x-ms-excel|application/x-excel|application/xls'"

SecAction "id:999101,phase:1,nolog,pass, \
  setvar:'tx.allowed_mime_xlsx=application/vnd.openxmlformats-officedocument.spreadsheetml.sheet|application/xlsx|application/vnd.ms-excel.sheet.macroenabled.12'"

# Tùy chọn: cho phép application/octet-stream (SDK/ứng dụng cũ hay dùng)
# 0 = không cho; 1 = cho phép
SecAction "id:999102,phase:1,nolog,pass,setvar:'tx.allow_octet_stream=0'"

# XLS (Excel binary, .xls) 
SecRule MULTIPART_FILENAME "@rx (?i)\.xls$" \
  "id:999124,phase:2,pass,log,chain,t:none,tag:'waf:upload',severity:2,msg:'XLS: validate MIME'"
SecRule &MULTIPART_PART_HEADERS:Content-Type "@ge 1" "pass,chain,t:none"
SecRule MULTIPART_PART_HEADERS:Content-Type "!@rx (?i)^application/(?:vnd\.ms-excel|msexcel|x-msexcel|x-ms-excel|x-excel|xls)(?:\s*;.*)?$" \
   "deny,status:403,log,msg:'Upload denied: XLS has an invalid Content-Type (got: %{MATCHED_VAR})'"

# --- XLSX ---
SecRule MULTIPART_FILENAME "@rx (?i)\.xlsx$" \
  "id:999125,phase:2,pass,log,chain,t:none,tag:'waf:upload',severity:2, \
   msg:'XLSX: validate per-part Content-Type', \
   setvar:tx.upload_fname=%{MATCHED_VAR}"
SecRule &MULTIPART_PART_HEADERS:Content-Type "@ge 1" "pass,chain,t:none"
SecRule MULTIPART_PART_HEADERS:Content-Type \
    "!@rx (?i)^(?:%{tx.allowed_mime_xlsx})(?:\s*;.*)?$" \
    "deny,status:403,log,tag:'waf:upload',severity:2, \
    msg:'Upload bị chặn: XLSX có Content-Type không hợp lệ (got: %{MATCHED_VAR}; file=%{tx.upload_fname})'"

