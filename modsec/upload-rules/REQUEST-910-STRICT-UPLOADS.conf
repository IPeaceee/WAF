
### REQUEST-910-STRICT-UPLOADS.conf ###
# ID range used: 999100-999199 (custom rules)
# Phase: 2 (request body)
# Tags: waf:upload
# Severity: 2 (medium)

# --- Deny filenames with disallowed extensions (positive allowlist) ---
# Allowed extensions: xlsx, xls, jpg, jpeg, png, pdf
SecRule MULTIPART_FILENAME "!@rx (?i)(?:^|[\\\/])[^\\\/]+\.(?:xlsx|xls|jpe?g|png|pdf)$" \
    "id:999110,phase:2,deny,status:403,log,t:none,tag:'waf:upload',severity:2,msg:'Upload denied: Extension is not allowed (got: %{MATCHED_VAR})'"


# --- Mapping: Extension must match per-part Content-Type (if part headers available) ---
# JPEG
SecRule MULTIPART_FILENAME "@rx (?i)\.jpe?g$" \
  "id:999111,phase:2,pass,log,chain,t:none,tag:'waf:upload',severity:2,msg:'JPEG: check MIME follow Content-Type'"
SecRule &MULTIPART_PART_HEADERS:Content-Type "@ge 1" "pass,chain,t:none"
SecRule MULTIPART_PART_HEADERS:Content-Type "!@rx (?i)^image/(?:jpeg|pjpeg|jpg)(?:\s*;.*)?$" \
  "deny,status:403,log,msg:'Upload denied: The JPEG has an invalid Content-Type (got: %{MATCHED_VAR})'"

# PNG
SecRule MULTIPART_FILENAME "@rx (?i)\.png$" \
    "id:999121,phase:2,t:none,log,pass,chain,msg:'Upload denied: PNG has an invalid Content-Type (got: %{MATCHED_VAR})',severity:2,tag:'waf:upload'"
SecRule &MULTIPART_PART_HEADERS:Content-Type "@ge 1" "t:none,pass,chain"
SecRule MULTIPART_PART_HEADERS:Content-Type "!@rx ^image/png$" "deny,status:403,log"

# PDF
SecRule MULTIPART_FILENAME "@rx (?i)\.pdf$" \
    "id:999122,phase:2,t:none,log,pass,chain,msg:'Upload denied: PDF has an invalid Content-Type (got: %{MATCHED_VAR})',severity:2,tag:'waf:upload'"
SecRule &MULTIPART_PART_HEADERS:Content-Type "@ge 1" "t:none,pass,chain"
SecRule MULTIPART_PART_HEADERS:Content-Type "!@rx ^application/pdf$" "deny,status:403,log"

# XLSX

SecRule MULTIPART_FILENAME "@rx (?i)\.xlsx$" \
    "id:999123,phase:2,t:none,log,pass,chain,msg:'Upload denied: XLSX has an invalid Content-Type (got: %{MATCHED_VAR})',severity:2,tag:'waf:upload'"
SecRule &MULTIPART_PART_HEADERS:Content-Type "@ge 1" "t:none,pass,chain"
SecRule MULTIPART_PART_HEADERS:Content-Type "!@rx ^application/vnd\.openxmlformats-officedocument\.spreadsheetml\.sheet$" "deny,status:403,log"

# XLS (Legacy Excel)
SecRule MULTIPART_FILENAME "@rx (?i)\.xls$" \
    "id:999124,phase:2,t:none,log,pass,chain,msg:'Upload denied: XLS has an invalid Content-Type (got: %{MATCHED_VAR})',severity:2,tag:'waf:upload'"
SecRule &MULTIPART_PART_HEADERS:Content-Type "@ge 1" "t:none,pass,chain"
SecRule MULTIPART_PART_HEADERS:Content-Type "!@rx ^application/vnd\.ms-excel$" "deny,status:403,log"

# --- Deny any file part whose Content-Type is not in the allowlist (if available) ---
SecRule MULTIPART_FILENAME ".+" \
    "id:999130,phase:2,t:none,log,pass,chain,msg:'Upload denied: Content-Type phần upload không cho phép',severity:2,tag:'waf:upload'"
SecRule &MULTIPART_PART_HEADERS:Content-Type "@ge 1" "t:none,pass,chain"
SecRule MULTIPART_PART_HEADERS:Content-Type "!@rx ^(?:image/jpeg|image/png|application/pdf|application/vnd\.ms-excel|application/vnd\.openxmlformats-officedocument\.spreadsheetml\.sheet)$" \
    "deny,status:403,log"

# --- Optional hardening (commented) ---
# If ModSecurity is compiled with libmagic (@inspectFile), you can additionally verify the file
# signature (magic bytes). Uncomment and adjust the magic file path as needed.
# Note: Not available in all ModSecurity builds/connectors.
#
# SecRule FILES_TMPNAMES "@inspectFile /usr/share/file/magic" \
#     "id:999140,phase:2,log,pass,chain,msg:'Upload bị chặn: Kiểu file thực tế không khớp allowlist',severity:2,tag:'waf:upload'"
# SecRule MATCHED_VARS "!@rx (?i)^(?:JPEG image|PNG image|PDF document|Microsoft Excel|Microsoft Excel 2007|Composite Document File|OpenDocument Spreadsheet|Zip archive data)" \
#     "deny,status:403,log"

SecMarker STRICT_UPLOADS_END
